<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arta (Pemasukan & Pengeluaran)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .table-cell-status {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            user-select: none;
        }
        .table-cell-status:hover {
            transform: scale(1.1);
        }
        .paid { background-color: #4ade80; color: white; }a
        .unpaid { background-color: #f87171; color: white; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .overflow-x-auto::-webkit-scrollbar { height: 8px; }
        .overflow-x-auto::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Header Section -->
        <header class="mb-8 bg-white p-6 rounded-xl shadow-lg fade-in">
            <div class="flex flex-col md:flex-row items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="p-5 bg-sky-100 rounded-full mr-6">
                        <i class="fas fa-wallet fa-3x text-sky-500"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-sky-600">Kas Kelas Digital</h1>
                        <p class="text-slate-500">Pencatatan Pemasukan & Pengeluaran Kas.</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-green-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold text-green-800">Total Pemasukan</p>
                    <p id="total-pemasukan" class="text-2xl font-bold text-green-600">Rp 0</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold text-red-800">Total Pengeluaran</p>
                    <p id="total-pengeluaran" class="text-2xl font-bold text-red-600">Rp 0</p>
                </div>
                <div class="bg-sky-100 p-4 rounded-lg">
                    <p class="text-lg font-semibold text-sky-800">Sisa Saldo Kas</p>
                    <p id="sisa-saldo" class="text-2xl font-bold text-sky-600">Rp 0</p>
                </div>
            </div>
        </header>

        <!-- Controls Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 fade-in" style="animation-delay: 0.1s;">
            <h2 class="text-xl font-semibold mb-4">Panel Kontrol Pemasukan</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label for="nama-siswa" class="block text-sm font-medium text-slate-700 mb-1">Nama Siswa Baru</label>
                    <div class="flex">
                        <input type="text" id="nama-siswa" placeholder="Contoh: Budi Hartono" class="w-full px-4 py-2 border border-slate-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button id="tambah-siswa-btn" class="bg-sky-500 text-white font-semibold px-5 py-2 rounded-r-lg hover:bg-sky-600 transition-colors"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                 <div>
                    <label for="kas-per-minggu" class="block text-sm font-medium text-slate-700 mb-1">Nominal Kas / Minggu (Rp)</label>
                    <input type="number" id="kas-per-minggu" value="5000" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
                <div class="flex flex-col justify-end gap-2">
                     <button id="export-pemasukan-btn" class="w-full bg-green-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-green-600 transition-colors"><i class="fas fa-file-excel mr-2"></i>Backup Pemasukan</button>
                    <button id="reset-data-btn" class="w-full bg-orange-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-orange-600 transition-colors"><i class="fas fa-sync-alt mr-2"></i>Reset Iuran Tahunan</button>
                </div>
            </div>
        </div>
        
        <!-- Expenses Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-xl font-semibold mb-4">Manajemen Pengeluaran</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Form Pengeluaran -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-slate-700">Tambah Pengeluaran Baru</h3>
                    <div class="space-y-4">
                         <div>
                            <label for="keterangan-pengeluaran" class="block text-sm font-medium text-slate-700 mb-1">Keterangan</label>
                            <input type="text" id="keterangan-pengeluaran" placeholder="Contoh: Beli spidol whiteboard" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div>
                            <label for="jumlah-pengeluaran" class="block text-sm font-medium text-slate-700 mb-1">Jumlah (Rp)</label>
                            <input type="number" id="jumlah-pengeluaran" placeholder="Contoh: 25000" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button id="tambah-pengeluaran-btn" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-sky-600 transition-colors"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button id="export-pengeluaran-btn" class="bg-red-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-600 transition-colors"><i class="fas fa-file-excel mr-2"></i>Backup Pengeluaran</button>
                        </div>
                    </div>
                </div>
                <!-- Daftar Pengeluaran -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-slate-700">Riwayat Pengeluaran</h3>
                    <div id="list-pengeluaran" class="h-64 overflow-y-auto pr-2 space-y-2">
                        <!-- Data pengeluaran akan dimuat di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Income Table Section -->
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md fade-in" style="animation-delay: 0.3s;">
             <h2 class="text-xl font-semibold mb-4">Tabel Iuran Kas Siswa</h2>
            <p class="text-sm text-slate-500 mb-4 text-center"><i class="fas fa-info-circle mr-2"></i>Klik pada kotak minggu untuk mengubah status pembayaran. Tabel bisa digeser ke kanan.</p>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-200 sticky top-0">
                        <tr>
                            <th scope="col" class="px-3 py-3 rounded-tl-lg">No</th>
                            <th scope="col" class="px-6 py-3 min-w-[150px]">Nama</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-kas-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const TOTAL_WEEKS = 52;

            // --- DOM Elements ---
            const tambahSiswaBtn = document.getElementById('tambah-siswa-btn');
            const namaSiswaInput = document.getElementById('nama-siswa');
            const tabelHeadRow = document.querySelector('#tabel-kas-body').previousElementSibling.querySelector('tr');
            const tabelBody = document.getElementById('tabel-kas-body');
            const kasPerMingguInput = document.getElementById('kas-per-minggu');
            const exportPemasukanBtn = document.getElementById('export-pemasukan-btn');
            const resetDataBtn = document.getElementById('reset-data-btn');
            // Dashboard Displays
            const totalPemasukanDisplay = document.getElementById('total-pemasukan');
            const totalPengeluaranDisplay = document.getElementById('total-pengeluaran');
            const sisaSaldoDisplay = document.getElementById('sisa-saldo');
            // Expenses Elements
            const keteranganPengeluaranInput = document.getElementById('keterangan-pengeluaran');
            const jumlahPengeluaranInput = document.getElementById('jumlah-pengeluaran');
            const tambahPengeluaranBtn = document.getElementById('tambah-pengeluaran-btn');
            const listPengeluaran = document.getElementById('list-pengeluaran');
            const exportPengeluaranBtn = document.getElementById('export-pengeluaran-btn');

            // --- State ---
            let students = [];
            let expenses = [];

            // --- Functions ---
            const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);

            const saveData = () => {
                localStorage.setItem('kasKelasDataMingguan', JSON.stringify(students));
                localStorage.setItem('kasKelasExpenses', JSON.stringify(expenses));
                localStorage.setItem('kasPerMinggu', kasPerMingguInput.value);
            };

            const loadData = () => {
                students = JSON.parse(localStorage.getItem('kasKelasDataMingguan')) || [];
                expenses = JSON.parse(localStorage.getItem('kasKelasExpenses')) || [];
                kasPerMingguInput.value = localStorage.getItem('kasPerMinggu') || '5000';
            };

            const updateDashboard = () => {
                const kasPerMinggu = parseInt(kasPerMingguInput.value) || 0;
                const totalPemasukan = students.reduce((acc, student) => {
                    const paidWeeks = student.payments.filter(status => status).length;
                    return acc + (paidWeeks * kasPerMinggu);
                }, 0);
                
                const totalPengeluaran = expenses.reduce((acc, expense) => acc + expense.amount, 0);
                
                const sisaSaldo = totalPemasukan - totalPengeluaran;

                totalPemasukanDisplay.textContent = formatRupiah(totalPemasukan);
                totalPengeluaranDisplay.textContent = formatRupiah(totalPengeluaran);
                sisaSaldoDisplay.textContent = formatRupiah(sisaSaldo);
            };
            
            // --- Pemasukan (Income) Functions ---
            const generateTableHeaders = () => {
                for(let i = 1; i <= TOTAL_WEEKS; i++) {
                    const th = document.createElement('th');
                    th.scope = 'col'; th.className = 'px-2 py-3 text-center'; th.textContent = `M${i}`;
                    tabelHeadRow.appendChild(th);
                }
                const actionTh = document.createElement('th');
                actionTh.scope = 'col'; actionTh.className = 'px-3 py-3 rounded-tr-lg text-center'; actionTh.textContent = 'Aksi';
                tabelHeadRow.appendChild(actionTh);
            };
            
            const renderStudentsTable = () => {
                tabelBody.innerHTML = '';
                if(students.length === 0) {
                    tabelBody.innerHTML = `<tr><td colspan="${TOTAL_WEEKS + 3}" class="text-center p-8 text-slate-500">Belum ada data siswa.</td></tr>`;
                }
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-slate-50';
                    row.dataset.id = student.id;
                    let rowHTML = `<td class="px-3 py-4 font-medium text-slate-900">${index + 1}</td><td class="px-6 py-4 font-semibold">${student.name}</td>`;
                    student.payments.forEach((isPaid, weekIndex) => {
                        rowHTML += `<td class="px-2 py-2 text-center"><div class="table-cell-status w-8 h-8 mx-auto rounded-md flex items-center justify-center font-bold text-lg ${isPaid ? 'paid' : 'unpaid'}" data-minggu="${weekIndex + 1}" title="${isPaid ? 'Lunas' : 'Belum'}">${isPaid ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}</div></td>`;
                    });
                    rowHTML += `<td class="px-3 py-4 text-center"><button class="delete-btn text-red-500 hover:text-red-700" title="Hapus Siswa"><i class="fas fa-trash-alt"></i></button></td>`;
                    row.innerHTML = rowHTML;
                    tabelBody.appendChild(row);
                });
                updateDashboard();
            };

            const addStudent = () => {
                const name = namaSiswaInput.value.trim();
                if (name) {
                    students.push({ id: Date.now(), name: name, payments: Array(TOTAL_WEEKS).fill(false) });
                    namaSiswaInput.value = '';
                    saveData();
                    renderStudentsTable();
                } else alert('Nama siswa tidak boleh kosong!');
            };

            const handleStudentTableClick = (e) => {
                const target = e.target.closest('.table-cell-status');
                const deleteBtn = e.target.closest('.delete-btn');
                if (target) {
                    const student = students.find(s => s.id === parseInt(target.closest('tr').dataset.id));
                    if (student) {
                        const weekIndex = parseInt(target.dataset.minggu) - 1;
                        student.payments[weekIndex] = !student.payments[weekIndex];
                        saveData();
                        renderStudentsTable();
                    }
                }
                if (deleteBtn) {
                     if(confirm('Yakin ingin menghapus siswa ini?')) {
                        students = students.filter(s => s.id !== parseInt(deleteBtn.closest('tr').dataset.id));
                        saveData();
                        renderStudentsTable();
                     }
                }
            };

            const resetYearlyData = () => {
                if (confirm('PERINGATAN! Ini akan mereset SEMUA status iuran siswa menjadi "Belum Lunas". Lanjutkan?')) {
                    students.forEach(student => student.payments.fill(false));
                    saveData();
                    renderStudentsTable();
                    alert('Data iuran tahunan telah direset.');
                }
            };
            
            // --- Pengeluaran (Expenses) Functions ---
            const renderExpenses = () => {
                listPengeluaran.innerHTML = '';
                if(expenses.length === 0) {
                    listPengeluaran.innerHTML = `<p class="text-center text-slate-500 p-4">Belum ada pengeluaran.</p>`;
                    return;
                }
                const reversedExpenses = [...expenses].reverse();
                reversedExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    item.className = 'bg-slate-100 p-3 rounded-lg flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${expense.description}</p>
                            <p class="text-sm text-slate-500">${formatRupiah(expense.amount)} - ${expense.date}</p>
                        </div>
                        <button class="delete-expense-btn text-red-400 hover:text-red-600" data-id="${expense.id}" title="Hapus Pengeluaran"><i class="fas fa-trash-alt"></i></button>
                    `;
                    listPengeluaran.appendChild(item);
                });
                updateDashboard();
            };

            const addExpense = () => {
                const description = keteranganPengeluaranInput.value.trim();
                const amount = parseInt(jumlahPengeluaranInput.value);
                if (description && amount > 0) {
                    expenses.push({ id: Date.now(), description, amount, date: new Date().toLocaleDateString('id-ID') });
                    keteranganPengeluaranInput.value = '';
                    jumlahPengeluaranInput.value = '';
                    saveData();
                    renderExpenses();
                } else {
                    alert('Keterangan dan Jumlah pengeluaran harus diisi dengan benar!');
                }
            };

            const handleExpenseListClick = (e) => {
                const deleteBtn = e.target.closest('.delete-expense-btn');
                if (deleteBtn) {
                    if (confirm('Yakin ingin menghapus data pengeluaran ini?')) {
                        expenses = expenses.filter(ex => ex.id !== parseInt(deleteBtn.dataset.id));
                        saveData();
                        renderExpenses();
                    }
                }
            };
            
            // --- Export Functions ---
            const exportToCSV = (data, filename, headers) => {
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';
                csvContent += data.map(row => row.join(',')).join('\n');
                
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `${filename}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const triggerPemasukanExport = () => {
                if (students.length === 0) return alert('Tidak ada data pemasukan untuk di-backup.');
                const headers = ['No', 'Nama', ...Array.from({length: TOTAL_WEEKS}, (_, i) => `M${i + 1}`)];
                const data = students.map((s, i) => [i + 1, `"${s.name}"`, ...s.payments.map(p => p ? 'Lunas' : 'Belum')]);
                exportToCSV(data, 'backup_pemasukan_kas', headers);
            };
            
            const triggerPengeluaranExport = () => {
                if (expenses.length === 0) return alert('Tidak ada data pengeluaran untuk di-backup.');
                const headers = ['No', 'Tanggal', 'Keterangan', 'Jumlah'];
                const data = expenses.map((e, i) => [i + 1, e.date, `"${e.description}"`, e.amount]);
                exportToCSV(data, 'backup_pengeluaran_kas', headers);
            };


            // --- Event Listeners ---
            tambahSiswaBtn.addEventListener('click', addStudent);
            namaSiswaInput.addEventListener('keypress', e => { if (e.key === 'Enter') addStudent(); });
            tabelBody.addEventListener('click', handleStudentTableClick);
            kasPerMingguInput.addEventListener('change', () => { saveData(); updateDashboard(); });
            kasPerMingguInput.addEventListener('keyup', updateDashboard);
            resetDataBtn.addEventListener('click', resetYearlyData);
            exportPemasukanBtn.addEventListener('click', triggerPemasukanExport);
            
            tambahPengeluaranBtn.addEventListener('click', addExpense);
            jumlahPengeluaranInput.addEventListener('keypress', e => { if(e.key === 'Enter') addExpense(); });
            listPengeluaran.addEventListener('click', handleExpenseListClick);
            exportPengeluaranBtn.addEventListener('click', triggerPengeluaranExport);


            // --- Initial Load ---
            generateTableHeaders();
            loadData();
            renderStudentsTable();
            renderExpenses();
        });
    </script>
</body>
</html>


